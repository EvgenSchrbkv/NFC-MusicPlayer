alias: NFC Наступний альбом
description: >-
  Перемикає альбом відповідного виконавця, залежно від останньої відсканованої
  мітки
triggers:
  - event_type: esphome.album_next
    trigger: event
conditions:
  - condition: state
    entity_id: media_player.home_mini_2     #your media player
    state: playing
  - condition: template
    value_template: "{{ artist_data is not none }}"
actions:
  - action: media_player.clear_playlist
    metadata: {}
    data: {}
    target:
      entity_id: media_player.home_mini_2         #your media player
  - variables:
      selected: "{{ filtered_albums | random }}"
  - condition: template
    value_template: "{{ selected is not none }}"
  - action: media_player.media_stop
    target:
      entity_id: media_player.home_mini_2         #your media player
    data: {}
  - delay: 1
  - target:
      entity_id: media_player.home_mini_2        #your media player
    data:
      message: "{{ artist_name }} — {{ selected.title }}"
    action: chime_tts.say
  - action: media_player.media_stop
    target:
      entity_id: media_player.home_mini_2         #your media player
    data: {}
  - target:
      entity_id: media_player.home_mini_2        #your media player
    data:
      media_content_id: "{{ selected.id }}"
      media_content_type: playlist
    action: media_player.play_media
  - wait_template: "{{ states('media_player.home_mini_2') == 'playing' }}"         #your media player
    timeout: 15
  - action: media_player.media_pause
    target:
      entity_id: media_player.home_mini_2            #your media player
    data: {}
  - action: media_player.media_play
    target:
      entity_id: media_player.home_mini_2            #your media player
    data: {}
  - target:
      entity_id: input_text.last_album_played
    data:
      value: "{{ artist_code }}:{{ selected.id }}"
    action: input_text.set_value
  - data:
      name: NFC Album Switch
      message: Перемкнено на {{ artist_name }} — {{ selected.title }}
      entity_id: input_text.last_tag_id
    action: logbook.log
mode: single
variables:
  artists_dict:
    53-0E-4D-09-51-00-01:              #NFC tag
      artist: like                      
      name: Музика що сподобалась
      albums:
        - title: null
          id: library://playlist/24           # your playlist for this tag
    53-12-67-09-51-00-01:                      #NFC tag
      artist: skillet
      name: Skillet
      albums:
        - title: Dominion 2022
          id: library://playlist/64          # your playlist for this tag
        - title: Victorious 2019
          id: library://playlist/63          # your playlist for this tag
        - title: Unleashed 2016
          id: library://playlist/62          # your playlist for this tag
        - title: Rise 2013
          id: library://playlist/61          # your playlist for this tag
        - title: Comatose 2006
          id: library://playlist/65          # your playlist for this tag
        - title: Awake 2009
          id: library://playlist/66          # your playlist for this tag
    53-81-57-09-51-00-01:
      artist: smuzi
      name: Grandma's Smuzi
      albums:
        - title: Grandma's Smuzi
          id: library://playlist/58
    53-2E-63-09-51-00-01:
      artist: lp
      name: Linkin Park
      albums:
        - title: Living Things 2012
          id: library://playlist/13
        - title: Meteora 2003
          id: library://playlist/10
        - title: Hybrid Theory 2000
          id: library://playlist/8
        - title: The Hunting Party 2014
          id: library://playlist/14
        - title: One More Light 2017
          id: library://playlist/15
        - title: Minutes To Midnight 2007
          id: library://playlist/11
        - title: From Zero 2024
          id: library://playlist/9
        - title: A Thousand Suns 2010
          id: library://playlist/12
  last_tag_id: "{{ states('input_text.last_tag_id') }}"
  artist_data: "{{ artists_dict.get(last_tag_id) }}"
  last_played_raw: "{{ states('input_text.last_album_played') }}"
  last_album_id: |
    {% if last_played_raw and ':' in last_played_raw %}
      {{ last_played_raw.split(':')[1] }}
    {% else %}""{% endif %}
  albums: "{{ artist_data.albums if artist_data else [] }}"
  filtered_albums: >
    {% set filtered = albums | rejectattr('id', 'equalto', last_album_id) | list
    %} {% if filtered | length > 0 %}
      {{ filtered }}
    {% else %}
      {{ albums }}
    {% endif %}
  artist_code: "{{ artist_data.artist if artist_data else 'unknown' }}"
  artist_name: "{{ artist_data.name if artist_data else 'Невідомий виконавець' }}"
